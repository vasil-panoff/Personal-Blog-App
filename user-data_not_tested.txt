#!/bin/bash
set -e

APP_DIR="/home/ec2-user/personal_blog"
VENV_DIR="$APP_DIR/venv"
SERVICE_FILE="/etc/systemd/system/personal_blog.service"
NGINX_CONF="/etc/nginx/conf.d/personal_blog.conf"
USER="ec2-user"
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)

echo "=== Updating system packages ==="
sudo yum update -y

echo "=== Installing dependencies ==="
sudo yum install -y python3 python3-venv python3-pip nginx

echo "=== Creating virtual environment ==="
python3 -m venv $VENV_DIR
source $VENV_DIR/bin/activate
pip install --upgrade pip
pip install flask gunicorn boto3  # add other dependencies if needed

echo "=== Creating systemd service ==="
sudo tee $SERVICE_FILE > /dev/null <<EOL
[Unit]
Description=Personal Blog Flask App
After=network.target

[Service]
User=$USER
Group=$USER
WorkingDirectory=$APP_DIR
Environment="PATH=$VENV_DIR/bin"
ExecStart=$VENV_DIR/bin/gunicorn -w 4 -b 127.0.0.1:8000 app:app

[Install]
WantedBy=multi-user.target
EOL

echo "=== Reloading systemd and starting service ==="
sudo systemctl daemon-reload
sudo systemctl enable personal_blog
sudo systemctl start personal_blog
sudo systemctl status personal_blog

echo "=== Creating Nginx configuration ==="
sudo tee $NGINX_CONF > /dev/null <<EOL
server {
    listen 80;
    server_name $PUBLIC_IP;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOL

echo "=== Testing Nginx configuration and restarting ==="
sudo nginx -t
sudo systemctl enable nginx
sudo systemctl start nginx
sudo systemctl status nginx

echo "=== Setup complete! Access your blog at http://$PUBLIC_IP/ ==="
